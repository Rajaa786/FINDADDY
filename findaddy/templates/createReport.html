{% extends 'base.html' %} {% load static %} {% block body %}
<body
	class="loading"
	data-layout-config='{"leftSideBarTheme":"dark","layoutBoxed":false, "leftSidebarCondensed":false, "leftSidebarScrollable":false,"darkMode":false, "showRightSidebarOnStart": true}'
>
	<!-- Begin page -->
	<div class="wrapper">
		<!-- ========== Left Sidebar Start ========== -->
		<div class="leftside-menu">
			<!-- LOGO -->
			<a href="index.html" class="logo text-center logo-light">
				<span class="logo-lg">
					<img
						src="{% static 'images/logo.png' %}"
						alt=""
						height="60"
					/>
				</span>
				<span class="logo-sm">
					<img
						src="{% static 'images/logo_sm.png' %}"
						alt=""
						height="30"
					/>
				</span>
			</a>

			<!-- LOGO -->
			<a href="index.html" class="logo text-center logo-dark">
				<span class="logo-lg">
					<img
						src="{% static 'images/logo-dark.png' %}"
						alt=""
						height="60"
					/>
				</span>
				<span class="logo-sm">
					<img
						src="{% static 'images/logo_sm_dark.png' %}"
						alt=""
						height="30"
					/>
				</span>
			</a>

			<div class="h-100" id="leftside-menu-container" data-simplebar="">
				<!--- Sidemenu -->
				<ul class="side-nav">
					<li class="side-nav-item">
						<a href="{% url 'dashboard' %}" class="side-nav-link">
							<i class="uil-home-alt"></i>
							<span> DashBoard </span>
						</a>
					</li>

					<li class="side-nav-item menuitem-active">
						<a
							href="{% url 'createReport' %}"
							class="side-nav-link"
						>
							<i class="uil-comments-alt"></i>
							<span> Generate Report </span>
						</a>
					</li>

					<li class="side-nav-item">
						<a href="{% url 'viewReport' %}" class="side-nav-link">
							<i class="uil-rss"></i>
							<span> View Report </span>
						</a>
					</li>
				</ul>

				<!-- Help Box -->
				<div class="help-box text-white text-center">
					<a
						href="javascript: void(0);"
						class="float-end close-btn text-white"
					>
						<i class="mdi mdi-close"></i>
					</a>
					<img
						src="{% static 'images/help-icon.svg' %}"
						height="90"
						alt="Helper Icon Image"
					/>
					<h5 class="mt-3">Unlimited Access</h5>
					<p class="mb-3">
						Upgrade to plan to get access to unlimited reports
					</p>
					<a
						href="javascript: void(0);"
						class="btn btn-outline-light btn-sm"
						>Upgrade</a
					>
				</div>
				<!-- end Help Box -->
				<!-- End Sidebar -->

				<div class="clearfix"></div>
			</div>
			<!-- Sidebar -left -->
		</div>
		<!-- Left Sidebar End -->

		<!-- ============================================================== -->
		<!-- Start Page Content here -->
		<!-- ============================================================== -->

		<div class="content-page">
			<div class="content">
				<!-- Topbar Start -->
				<div class="navbar-custom">
					<ul class="list-unstyled topbar-menu float-end mb-0">
						<li class="dropdown notification-list">
							<a
								class="nav-link dropdown-toggle nav-user arrow-none me-0 d-flex align-items-center"
								data-bs-toggle="dropdown"
								href="#"
								role="button"
								aria-haspopup="false"
								aria-expanded="false"
							>
								<span class="account-user-avatar">
									<img
										src="{% static 'images/users/avatar-1.jpg' %}"
										alt="user-image"
										class="rounded-circle"
									/>
								</span>
								<span>
									<span class="account-user-name"
										>{{request.session.name}}</span
									>
								</span>
							</a>
							<div
								class="dropdown-menu dropdown-menu-end dropdown-menu-animated topbar-dropdown-menu profile-dropdown"
							>
								<!-- item-->
								<div class="dropdown-header noti-title">
									<h6 class="text-overflow m-0">Welcome !</h6>
								</div>

								<!-- item-->
								<a
									href="javascript:void(0);"
									class="dropdown-item notify-item"
								>
									<i class="mdi mdi-account-circle me-1"></i>
									<span>My Account</span>
								</a>

								<!-- item-->
								<a
									href="javascript:void(0);"
									class="dropdown-item notify-item"
								>
									<i class="mdi mdi-account-edit me-1"></i>
									<span>Settings</span>
								</a>

								<!-- item-->
								<a
									href="javascript:void(0);"
									class="dropdown-item notify-item"
								>
									<i class="mdi mdi-lifebuoy me-1"></i>
									<span>Support</span>
								</a>

								<!-- item-->
								<a
									href="javascript:void(0);"
									class="dropdown-item notify-item"
								>
									<i class="mdi mdi-lock-outline me-1"></i>
									<span>Lock Screen</span>
								</a>

								<!-- item-->
								<a
									href="/logout/"
									class="dropdown-item notify-item"
								>
									<i class="mdi mdi-logout me-1"></i>
									<span>Logout</span>
								</a>
							</div>
						</li>
					</ul>
					<button class="button-menu-mobile open-left">
						<i class="mdi mdi-menu"></i>
					</button>
				</div>
				<!-- end Topbar -->

				<!-- Start Content-->
				<div class="container-fluid">
					{% if message %}
					<div
						class="alert alert-danger alert-dismissible"
						role="alert"
					>
						{{ message }}
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="alert"
							aria-label="Close"
						></button>
					</div>
					{% endif %}
					<!-- start page title -->
					<div class="row">
						<div class="col-12">
							<div class="page-title-box">
								<h4 class="page-title">Create Report</h4>
							</div>
						</div>
					</div>
					<!-- end page title -->

					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-body">
									<form
										action="/create_report_ajax/"
										method="post"
										enctype="multipart/form-data"
										id="report-form"
									>
										{% csrf_token %}
										<div class="mb-3">
											<label
												for="reportname"
												class="form-label"
												>Report Name</label
											>
											<input
												type="text"
												id="reportname"
												class="form-control"
												name="reportname"
												required
											/>
										</div>
										<div class="mb-3">
											<label
												for="bankname"
												class="form-label"
												>Bank Name</label
											>
											<select
												id="bankname"
												class="form-control select2"
												data-toggle="select2"
												name="bankname"
												required
											>
												<option>Select</option>
												<option value="AXIS">
													AXIS Bank Ltd
												</option>
												<option value="ICICI">
													ICICI Bank Ltd
												</option>
												<option value="HDFC">
													HDFC Bank Ltd
												</option>
												<option value="KOTAK">
													KOTAK MAHINDRA Bank Ltd
												</option>
												<option value="SBI">
													STATE BANK OF INDIA
												</option>
												<option value="IDFC">
													IDFC FIRST BANK
												</option>
												<option value="UNION">
													UNION BANK OF INDIA
												</option>
												<option value="YES">
													YES BANK LTD
												</option>
												<option value="BOB">
													BANK OF BARODA
												</option>
												<option value="PNB">
													PUNJAB NATIONAL BANK LTD
												</option>
											</select>
										</div>
										<div class="mb-3">
											<label
												for="accountType"
												class="form-label"
												>Account Type</label
											>
											<select
												id="accountType"
												class="form-control select2"
												data-toggle="select2"
												name="accountType"
												required
											>
												<option>Select</option>
												<option value="saving">
													Savings
												</option>
												<option value="current">
													Current
												</option>
												<option value="other">
													Overdraft / Cash Credit
												</option>
											</select>
										</div>
										<div class="mb-3">
											<label
												for="accountNumber"
												class="form-label"
												>Account Number</label
											>
											<input
												class="form-control"
												id="accountNumber"
												type="number"
												name="accountNumber"
												required
											/>
										</div>
										<div class="mb-3">
											<label
												for="accountStatement"
												class="form-label"
												>Account Statement PDF</label
											>
											<input
												type="file"
												id="accountStatement"
												class="form-control"
												name="accountStatement"
												accept="application/pdf"
												required
											/>
										</div>
										<div class="mb-3">
											<label
												for="pdfpassword"
												class="form-label"
												>PDF Password (If Any)</label
											>
											<input
												type="password"
												id="pdfpassword"
												class="form-control"
												name="pdfpassword"
											/>
										</div>
										<div class="mb-3">
											<label
												for="startdate"
												class="form-label"
												>Start Date</label
											>
											<input
												class="form-control"
												id="startdate"
												type="date"
												name="startdate"
												value=""
												min="1997-01-01"
												max="2030-12-31"
												required
											/>
										</div>
										<div class="mb-3">
											<label
												for="enddate"
												class="form-label"
												>End Date</label
											>
											<input
												class="form-control"
												id="enddate"
												type="date"
												name="enddate"
												value=""
												min="1997-01-01"
												max="2030-12-31"
												required
											/>
										</div>
										<button
											type="submit"
											class="btn btn-primary float-none float-md-end"
										>
											Generate Report
										</button>
									</form>
								</div>
								<!-- end card-body -->
							</div>
							<!-- end card-->
						</div>
						<!-- end col-->
					</div>
					<!-- end row-->
				</div>
				<!-- container -->
			</div>
			<!-- content -->

			<!-- Footer Start -->
			<footer class="footer">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-6">
							<script>
								document.write(new Date().getFullYear());
							</script>
							Â© All rights reserved.
						</div>
						<div class="col-md-6">
							<div
								class="text-md-end footer-links d-none d-md-block"
							>
								<a href="javascript: void(0);">About</a>
								<a href="javascript: void(0);">Support</a>
								<a href="javascript: void(0);">Contact Us</a>
							</div>
						</div>
					</div>
				</div>
			</footer>
			<!-- end Footer -->
		</div>

		<!-- ============================================================== -->
		<!-- End Page content -->
		<!-- ============================================================== -->
	</div>
	<!-- END wrapper -->

	<!-- bundle -->
	<script src="{% static 'js/vendor.min.js' %}"></script>
	<script src="{% static 'js/app.min.js' %}"></script>

	<!-- custom js -->
	<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script type="text/javascript">
		console.log("Page Ready");
		$("#report-form").on("submit", function (event) {
			console.log("Form Submitted");
			event.preventDefault();
			Swal.fire({
				title: "Generating Report...",
				text: "Please wait while we generate your report",
				html: `<img src="{% static 'images/loading.svg' %}"/>`,
				showConfirmButton: false,
				allowOutsideClick: false,
			});
			var formData = new FormData(this);
			formData.set(
				"startdate",
				change_date_format(formData.get("startdate"))
			);
			formData.set(
				"enddate",
				change_date_format(formData.get("enddate"))
			);
			console.log("Generating Report...");
			create_post(formData);
			console.log("Report Generated!");
		});

		// AJAX for posting
		function create_post(data) {
			$.ajax({
				url: "{% url 'create_report_ajax' %}",
				type: "POST",
				data: data,
				contentType: false,
				cache: false,
				processData: false,
				success: function (data) {
					console.log(data);
					if (data == "limit reached") {
						Swal.fire({
							title: "Limit Reached",
							text: "You have reached the limit of generating reports. Please upgrade your plan.",
							icon: "error",
							confirmButtonText: "OK",
						});
					} else if (data == "Error") {
						Swal.fire({
							title: "Error",
							text: "Something went wrong. Please try again later.",
							icon: "error",
							confirmButtonText: "OK",
						});
					} else {
						console.log("Report generated successfully");
						Swal.fire({
							title: "Report Generated Successfully",
							icon: "success",
							footer:
								`<button type="button" class="btn btn-primary" onclick="window.open('` +
								data +
								`','_blank')">Download Report</button>`,
							showConfirmButton: false,
						});
						console.log(data);
					}
				},
				error: function (xhr, errmsg, err) {
					console.log(errmsg);
					console.log(err);
					console.log(xhr.status);
					console.log(xhr.responseText);
					if(xhr.status == 503){
						console.log("503 error");
						Swal.fire({
							title: "Please wait for 5 to 10 minutes.",
							icon: "warning",
							footer:
								`<button type="button" class="btn btn-primary" onclick="location.href='{% url 'viewReport' %}">Show Reports</button>`,
							showConfirmButton: false,
						});
					} else {
						console.log("Not 503 Error");
						Swal.fire({
							title: "Report Generation Failed",
							icon: "error",
							showConfirmButton: false,
							timer: 2000,
						});
					}
					/*
					if(xhr.status == 503){
						Swal.fire({
							title: "Report is getting generated...",
							text, "Please wait for a 5 to 10 minutes",
							icon: "warning",
							confirmButtonText: "OK",
						});
					} else {
						Swal.fire({
							title: "Report Generation Failed",
							icon: "error",
							showConfirmButton: false,
							timer: 2000,
						});
					}
					Swal.fire({
						title: "Report Generation Failed",
						icon: "error",
						showConfirmButton: false,
						timer: 2000,
					});
					*/
				},
			});
		}

		// Change Date format
		function change_date_format(date) {
			var date_array = date.split("-");
			var new_date =
				date_array[2] + "/" + date_array[1] + "/" + date_array[0];
			return String(new_date);
		}
	</script>
</body>
{% endblock body %}
